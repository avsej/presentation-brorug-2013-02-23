% vim:et:ts=2:sw=2:ft=tex:
\documentclass[aspectratio=43]{beamer}
%\documentclass[aspectratio=43,handout]{beamer}
\usepackage{cmap}

\usepackage{graphicx,epstopdf}
\usepackage{epsfig}
\usepackage{textcomp,xecyr,luatextra}
\usepackage{booktabs, caption}

\usepackage{amsmath}
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}
\usepackage[english]{babel}
\usepackage{hyperref}

\usepackage{tikz}
\usepackage{verbatim}
\usetikzlibrary{arrows, shapes, chains}

\usefonttheme{professionalfonts}
\usetheme{couchbase}

\title{Couchbase and Rails}
\author{Sergey Avseyev\\\texttt{sergey@couchbase.com}\\\texttt{@avsej}}
\hypersetup{
  unicode=true,
  colorlinks=true,
  citecolor=black,
  filecolor=black,
  linkcolor=black,
  urlcolor=blue,
  pdftoolbar=false,
  pdfmenubar=false,
  pdflang={en-US},
  pdftitle={Couchbase and Rails},
  pdfsubject={Using couchbase in Rails web-application context},
  pdfauthor={Sergey Avseyev <sergey@couchbase.com>},
  pdfkeywords={couchbase, rails, ruby}
}

\begin{document}

\titleback
\begin{frame}
  \titlepage
\end{frame}

\section{What is Couchbase}

\begin{frame}{Simple. Fast. Elastic.}
  \claim
    {Easy Scalability}
    {Grow cluster without application changes, without downtime}
\end{frame}
\fullpageimage{images/scalable.jpg}

\begin{frame}{Simple. Fast. Elastic.}
  \claim
    {Consistent High Performance}
    {Sub-millisecond read/write response \& high throughput}
\end{frame}
\fullpageimage{images/fast.jpg}

\begin{frame}{Simple. Fast. Elastic.}
  \claim
    {Always On 24x365}
    {No downtime for software upgrades, hardware maintenance, etc}
\end{frame}
\fullpageimage{images/always_on.jpg}

\begin{frame}{Simple. Fast. Elastic.}
  \claim
    {Flexible Data Model}
    {JSON document model with no fixed schema}
\end{frame}
\fullpageimage{images/flexible.jpg}

\section{gem i couchbase}
\begin{frame}[fragile]{Basic K/V Operations}
  % Simple access to the database using procedural-style API
  \begin{verbatim}
  Couchbase.bucket.incr("user:#{id}:hits", :initial => 1)
  Couchbase.bucket.set("user:#{id}:ip", "192.0.43.10")
  Couchbase.bucket.get("user:#{id}:token", :ttl => 1.day)
  \end{verbatim}
\end{frame}

\begin{frame}[fragile]{Rails Cache Store}
  \begin{verbatim}
  config.cache_store = :couchbase_store,
                       :bucket => 'cache',
                       :expires_in => 1.hour
  \end{verbatim}
\end{frame}

\begin{frame}[fragile]{Rails Session Store}
  \begin{verbatim}
  config.session_store :couchbase_store,
                       :namespace => "session:",
                       :couchbase => {
                         :bucket => 'sessions',
                         :default_format => :json
                       }
  \end{verbatim}
\end{frame}

\section{gem i couchbase-model}
\begin{frame}[fragile]{Generate Configuration}
  \begin{verbatim}
  $ rails generate couchbase:config
        create  config/couchbase.yml
  \end{verbatim}
\end{frame}

\begin{frame}[fragile]{config/couchbase.yml}
  \begin{verbatim}
  common: &common
    node_list:
      - example.com:8091
      - example.org:8091
      - example.net:8091
    username:
    password:

  development:
    <<: *common
    bucket: example_development

  production:
    <<: *common
    bucket: example_test
  \end{verbatim}
\end{frame}

\begin{frame}[fragile]{Modeling}
  \begin{verbatim}
  class Beer < Couchbase::Model
    attribute :name
    attribute :abv, :default => 0
    attribute :ibu, :default => 0
    attribute :category

    belongs_to :brewery

    view :all, :limit => 31

    before_save do |doc|
      doc.abv = doc.abv.to_f
      doc.ibu = doc.ibu.to_f
    end
  end
  \end{verbatim}
\end{frame}


\tikzstyle{doc} = [
  rectangle,
  on chain,
  on grid,
  draw,
  font=\ttfamily,
  align=left,
  inner xsep=1ex,
  text width=12em,
]

\tikzstyle{ndoc} = [
  doc,
  text width=7em,
]
\tikzstyle{code} = [
  on chain,
  on grid,
  font=\ttfamily,
]
\tikzstyle{dim} = [gray!20]
\tikzstyle{hide} = [white]

\tikzset{onslide/.code args={<#1>#2}{
  \only<#1>{\pgfkeysalso{#2}}
}}


\begin{frame}[fragile]{Views: How It Works: Map}
  \begin{tikzpicture}[
      >=latex,
      start chain=going below,
      node distance=1mm and 60mm,
      every join/.style={white},
      thick,
      auto
    ]
    \node[doc]                          (b1) {\{"type":"beer",...\}};
    \node[doc, onslide=<2->{dim}, join]      {\{"type":"brewery",...\}};
    \node[doc, join]                    (b2) {\{"type":"beer",...\}};
    \node[doc, onslide=<2->{dim}, join] (c)  {\{"type":"brewery",...\}};
    \node[doc, onslide=<2->{dim}, join]      {\{"type":"brewery",...\}};
    \node[doc, join]                    (b3) {\{"type":"beer",...\}};
    \node[doc, join]                    (b4) {\{"type":"beer",...\}};

    \node[code, right=of c, onslide=<1>{hide}] (f) {emit(doc.category, doc.abv)};


    \path[->, onslide=<1>{hide}] (b1.east) edge (f);
    \path[->, onslide=<1>{hide}] (b2.east) edge (f);
    \path[->, onslide=<1>{hide}] (b3.east) edge (f);
    \path[->, onslide=<1>{hide}] (b4.east) edge (f);
  \end{tikzpicture}
\end{frame}

\begin{frame}[fragile]{Views: How It Works: Reduce}
  \begin{tikzpicture}[
      >=latex,
      start chain=going below,
      node distance=1mm and 60mm,
      every join/.style={white},
      thick,
      auto
    ]

    \node[doc]        (r1)  {["German Ale", 5.2]};
    \node[doc, join]  (r2)  {["German Ale", 5.7]};
    \node[doc, join]  (r3)  {["German Lager", 6.3]};
    \node[doc, join]  (r4)  {["German Lager", 6.0]};
    \node[doc, join]  (r5)  {["German Lager", 6.2]};
    \node[doc, join]  (r6)  {["German Lager", 6.4]};
    \node[doc, join]  (r7)  {["Irish Ale", 5.8]};
    \node[doc, join]  (r8)  {["Irish Ale", 6.1]};
    \node[doc, join]  (r9)  {["Irish Ale", 5.1]};

    \node[code, right=of r5, onslide=<-1>{hide}] (f) {reduce(keys, values, false)};
    \path[->, onslide=<1-2>{hide}] (f) edge (f);

    \path[->, onslide=<1>{hide}] (r1.east) edge (f);
    \path[->, onslide=<1>{hide}] (r2.east) edge (f);
    \path[->, onslide=<1>{hide}] (r3.east) edge (f);
    \path[->, onslide=<1>{hide}] (r4.east) edge (f);
    \path[->, onslide=<1>{hide}] (r5.east) edge (f);
    \path[->, onslide=<1>{hide}] (r6.east) edge (f);
    \path[->, onslide=<1>{hide}] (r7.east) edge (f);
    \path[->, onslide=<1>{hide}] (r8.east) edge (f);
    \path[->, onslide=<1>{hide}] (r9.east) edge (f);

    % hack
  \end{tikzpicture}
\end{frame}



\begin{frame}[fragile]{Views: How It Works: Rereduce}
  \begin{tikzpicture}[
      >=latex,
      start chain=going below,
      node distance=1mm and 60mm,
      every join/.style={white},
      thick,
      auto
    ]

    \node[ndoc] (r1){\{"count": 4, "sum": 23.2, "avg": 5.8 \}};
    \node[ndoc, join] (r2){\{"count": 3, "sum": 18.4, "avg": 6.13\}};
    \node[ndoc, join] (r3){\{"count": 2, "sum": 11.2, "avg": 5.6\}};

    \node[code, right=of r2, onslide=<1>{hide}] (f) {reduce(null, values, true)};
    \path[->, onslide=<1-2>{hide}] (f) edge (f);

    \path[->, onslide=<1>{hide}] (r1.east) edge (f);
    \path[->, onslide=<1>{hide}] (r2.east) edge (f);
    \path[->, onslide=<1>{hide}] (r3.east) edge (f);
  \end{tikzpicture}
\end{frame}

\begin{frame}[fragile]{Views: Generator}
  \begin{verbatim}
  $ rails generate couchbase:view beer avg_by_category
        create  app/models/beer/avg_by_category/map.js
        create  app/models/beer/avg_by_category/reduce.js
  \end{verbatim}
\end{frame}

\begin{frame}[fragile]{Views: Map}
  \begin{verbatim}
  function(doc, meta) {
    if (doc.type == "beer" && doc.category && doc.abv > 0) {
      emit(doc.category, doc.abv);
    }
  }
  \end{verbatim}
\end{frame}

\begin{frame}[fragile]{Views: Reduce}
  \begin{semiverbatim}
  function (keys, values, rereduce) \{
    var ret = \{sum: 0, count: 0\};
    if (\alert<2,3>{rereduce}) \{ \only<2-3>{//} \only<3>{\alert{true}}\only<2>{\alert{false}}
      \alert<3>{for (var i = 0; i < values.length; ++i) \{
        ret.sum += values[i].sum;
        ret.count += values[i].count;
      \}}
    \} else \{
      \alert<2>{ret.sum = sum(values);
      ret.count = values.length;}
    \}
    ret.avg = ret.sum / ret.count;
    return ret;
  \}
  \end{semiverbatim}
\end{frame}

\begin{frame}[fragile]{Views: Model}
  \begin{verbatim}
  class Beer < Couchbase::Model
    ...

    view :avg_by_category, :group => true,
                           :include_docs => false

    ...
  end
  \end{verbatim}
\end{frame}

\begin{frame}[fragile]{Views: Execution}
  \begin{semiverbatim}
 001:0> Beer.avg_by_category.each do |beer|
 002:1*   printf("\alert<2>{\%s}: \alert<3>{\%.2f}\\n", \alert<2>{beer.key}, \alert<3>{beer.value["avg"]})
 003:1> end
 \alert<2>{Belgian and French Ale}: \alert<3>{7.39}
 \alert<2>{British Ale}: \alert<3>{6.93}
 \alert<2>{German Ale}: \alert<3>{5.67}
 \alert<2>{German Lager}: \alert<3>{6.22}
 \alert<2>{Irish Ale}: \alert<3>{5.94}
 \alert<2>{North American Ale}: \alert<3>{6.79}
 \alert<2>{North American Lager}: \alert<3>{4.97}
 \alert<2>{Other Lager}: \alert<3>{4.55}
 \alert<2>{Other Style}: \alert<3>{5.82}
 nil
  \end{semiverbatim}
\end{frame}

\begin{frame}[fragile]{Links}
  \begin{itemize}
    \item couchbase gem sources
      \url{https://github.com/couchbase/couchbase-ruby-client}
    \item couchbase issue tracker
      \url{http://couchbase.com/issues/browse/RCBC}
    \item couchbase-model gem sources
      \url{https://github.com/couchbase/couchbase-ruby-model}
    \item demo rails application
      \url{https://github.com/couchbaselabs/couchbase-beer.rb}
  \end{itemize}
\end{frame}

\section{And Even More}
\fullpageimage{images/more.jpg}
\begin{frame}[fragile]{Geospatial Views}
  \begin{center}
    {\Huge\bfseries Query your geo data}
    \vskip1em
    \url{http://couchbase.com/docs/couchbase-manual-2.0/couchbase-views-writing-geo.html}
  \end{center}
  \begin{verbatim}
function(doc, meta) {
  if (doc.geo && doc.geo.lng && doc.geo.lat && doc.name) {
    var key = {type: "Point",
               coordinates: [doc.geo.lng, doc.geo.lat]};
    var val = {name: doc.name, geo: doc.geo};
    emit(key, val);
  }
}
  \end{verbatim}
\end{frame}

\begin{frame}{ElasticSearch Integration}
  \begin{center}
    {\Huge\bfseries Rich queries with ElasticSearch}
    \vskip1em
    \url{http://couchbase.com/docs/couchbase-elasticsearch/}
  \end{center}
\end{frame}

\thanks
\end{document}
